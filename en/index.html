<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Casual Anatomy: Risk Scan </title>
  <meta name="description" content="Casual Anatomy — a quick risk scan of an item from 1–3 photos. Runs locally in your browser. © rara_illustra" />

  <style>
    :root{
      --bg:#f8f7ff;
      --surface:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:rgba(2,6,23,.10);

      --lilac:#b79cff;
      --lilac2:#9b7bff;
      --lilacSoft:rgba(183,156,255,.16);

      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --shadow: 0 16px 40px rgba(2,6,23,.10);
      --radius:18px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 420px at 12% -10%, var(--lilacSoft), transparent 60%),
        radial-gradient(900px 420px at 92% 0%, rgba(2,6,23,.06), transparent 55%),
        linear-gradient(180deg, #fbfaff, var(--bg));
    }

    /* Top bar */
    .top{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(160%) blur(10px);
      background:rgba(248,247,255,.88);
      border-bottom:1px solid rgba(2,6,23,.08);
    }
    .topbar{
      max-width:1100px;
      margin:0 auto;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:var(--lilac2);
      box-shadow:0 0 0 6px rgba(183,156,255,.18);
      flex:0 0 auto;
    }
    .brandTitle{
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandSub{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin-top:2px;
    }
    .pill{
      font-family:var(--mono);
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(2,6,23,.10);
      background:rgba(255,255,255,.65);
      color:rgba(2,6,23,.72);
      white-space:nowrap;
    }


    /* Language toggle */
    .lang{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }
    .langLink{
      text-decoration:none;
      font-family:var(--mono);
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(2,6,23,.10);
      background:rgba(255,255,255,.65);
      color:rgba(2,6,23,.72);
      white-space:nowrap;
      font-weight:900;
      transition:.15s ease;
    }
    .langLink:hover{ transform:translateY(-1px); }
    .langLink.active{
      background:rgba(183,156,255,.18);
      border-color: rgba(155,123,255,.35);
      color:rgba(20,10,43,.95);
      box-shadow:0 10px 22px rgba(155,123,255,.14);
    }


    /* Layout */
    .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
      .wrap{ padding:12px; }
    }

    .card{
      background:var(--surface);
      border:1px solid rgba(2,6,23,.10);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .pad{ padding:16px; }

    .h1{ margin:0 0 6px 0; font-size:20px; font-weight:900; }
    .p{ margin:0; color:var(--muted); line-height:1.5; font-size:14px; }
    .small{ font-size:12px; color:var(--muted); line-height:1.45; }
    .mono{ font-family:var(--mono); }

    /* Inputs */
    .field{ display:grid; gap:8px; margin-top:12px; }
    .label{ font-size:13px; font-weight:900; color:rgba(2,6,23,.85); }
    select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(2,6,23,.12);
      background:#fff;
      outline:none;
      font-weight:800;
    }
    select:focus{
      border-color: rgba(155,123,255,.55);
      box-shadow:0 0 0 4px rgba(155,123,255,.18);
    }

    /* Buttons */
    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(2,6,23,.12);
      background:#fff;
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{ transform:translateY(-1px); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; }
    .btnPrimary{
      background: linear-gradient(135deg, var(--lilac), var(--lilac2));
      border-color: rgba(155,123,255,.35);
      color:#140a2b;
      box-shadow:0 14px 30px rgba(155,123,255,.18);
    }
    .btnGhost{
      background:transparent;
    }
    .btnSmall{
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
    }

    /* Uploader */
    .uploader{
      margin-top:12px;
      border-radius:18px;
      padding:14px;
      border:1px dashed rgba(155,123,255,.55);
      background:rgba(183,156,255,.10);
    }
    input[type="file"]{ display:none; }

    .drop{
      border-radius:16px;
      background:rgba(255,255,255,.92);
      border:1px solid rgba(2,6,23,.06);
      padding:12px;
      display:grid;
      gap:10px;
    }
    .thumbs{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:6px;
    }
    .thumb{
      aspect-ratio: 3 / 4;
      border-radius:16px;
      border:1px solid rgba(2,6,23,.12);
      overflow:hidden;
      background:linear-gradient(180deg, rgba(2,6,23,.04), rgba(2,6,23,.00));
      position:relative;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; }
    .thumb .x{
      position:absolute; top:8px; right:8px;
      width:28px; height:28px;
      border-radius:999px;
      display:grid; place-items:center;
      background:rgba(255,255,255,.95);
      border:1px solid rgba(2,6,23,.12);
      cursor:pointer;
      font-weight:900;
      line-height:1;
    }

    .divider{ height:1px; background:rgba(2,6,23,.10); margin:10px 0; opacity:.35; }

    /* KPIs */
    .kpi{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 2fr;
      gap:10px;
    }
    @media (max-width:560px){
      .kpi{ grid-template-columns:1fr; }
    }

    .kpi .item{
      border:1px solid rgba(2,6,23,.10);
      border-radius:16px;
      padding:10px;
      background:rgba(255,255,255,.70);
    }
    .kpi .num{ font-family:var(--mono); font-weight:900; font-size:18px; }
    .kpi .lbl{ font-size:12px; color:var(--muted); }

    .kpiWide{ display:grid; gap:10px; }

    .kpiScale{
      position:relative;
      height:18px;
    }
    .kpiTrack{
      position:absolute; inset:0;
      border-radius:999px;
      background:rgba(2,6,23,.06);
      border:1px solid rgba(2,6,23,.08);
    }
    .kpiTicks{
      position:absolute; inset:0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 10px;
    }
    .kpiTicks span{
      width:6px; height:6px;
      border-radius:999px;
      background:rgba(2,6,23,.12);
    }

    .kpiMarker{
      position:absolute;
      top:50%;
      left:0%;
      transform:translate(-50%,-50%);
      width:16px; height:16px;
      border-radius:999px;
      background:linear-gradient(135deg, var(--lilac), var(--lilac2));
      border:2px solid rgba(255,255,255,.92);
      box-shadow:0 10px 20px rgba(155,123,255,.22);
      opacity:0;
      transition:left .22s ease, opacity .2s ease;
    }
    .kpiMarker.on{ opacity:1; }

    .kpiEnds{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      color:var(--muted);
      margin-top:-2px;
    }

    /* Phone / Preview */
    .phone{
      border-radius:28px;
      border:1px solid rgba(2,6,23,.10);
      box-shadow:var(--shadow);
      overflow:hidden;
      background:rgba(255,255,255,.80);
    }
    .phoneTop{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(2,6,23,.08);
      background:rgba(255,255,255,.70);
    }
    .screen{
      position:relative;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:560px;
    }
    @media (max-width:980px){
      .screen{ min-height: calc(100svh - 160px); }
    }

    .panel{
      border:1px solid rgba(2,6,23,.10);
      border-radius:18px;
      padding:14px;
      background:rgba(255,255,255,.92);
    }

    /* Advice column */
    .adviceCol{ display:grid; gap:10px; }
    .adviceCard{
      border:1px solid rgba(2,6,23,.10);
      border-radius:16px;
      padding:12px;
      background:rgba(255,255,255,.92);
    }
    .adviceTitle{
      font-weight:950;
      letter-spacing:.2px;
    }
    .adviceText{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }
    .adviceFinal{
      margin-top:10px;
      border-top:1px dashed rgba(2,6,23,.14);
      padding-top:10px;
      font-weight:950;
    }

    /* Preview image */
    .heroImg{
      border-radius:18px;
      border:1px solid rgba(2,6,23,.10);
      overflow:hidden;
      background:linear-gradient(135deg, rgba(183,156,255,.16), rgba(2,6,23,.02));
      aspect-ratio: 16 / 10;
      position:relative;
    }
    .heroImg img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      filter:saturate(1.05);
    }
    .heroOverlay{
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(2,6,23,.0), rgba(2,6,23,.22));
      display:flex;
      align-items:flex-end;
      padding:12px;
      color:white;
      font-weight:900;
      letter-spacing:.2px;
    }

    /* Scan overlay */
    .scanOverlay{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
      transition:.2s ease;
    }
    .scanOverlay.on{ opacity:1; }
    .scanLine{
      position:absolute; left:0; right:0; height:2px;
      top:-2px;
      background:rgba(155,123,255,.98);
      box-shadow:0 0 12px rgba(155,123,255,.35), 0 0 55px rgba(155,123,255,.16);
      animation: scanDown 2.1s linear infinite;
    }
    @keyframes scanDown{ 0%{top:-2px} 100%{top:100%} }

    /* Progress */
    .progressWrap{
      border:1px solid rgba(2,6,23,.10);
      border-radius:16px;
      padding:12px;
      background:rgba(255,255,255,.92);
    }
    .bar{
      height:10px; border-radius:999px;
      background:rgba(2,6,23,.08);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(135deg, var(--lilac), var(--lilac2));
      transition: width .22s ease;
    }

    /* Steps */
    .stepList{ display:grid; gap:8px; }
    .step{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid rgba(2,6,23,.10);
      border-radius:16px;
      padding:12px;
      background:rgba(255,255,255,.94);
    }
    .chip{
      font-family:var(--mono);
      font-size:12px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(155,123,255,.28);
      background:rgba(183,156,255,.14);
      color:rgba(20,10,43,.95);
      white-space:nowrap;
      font-weight:900;
    }
    .desc{ color:var(--muted); font-size:13px; line-height:1.35; }
    .tick{
      width:22px; height:22px;
      border-radius:999px;
      border:1px solid rgba(2,6,23,.14);
      background:rgba(2,6,23,.03);
      flex:0 0 auto;
    }
    .tick.on{ border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.12); }
    .tick.on::after{
      content:"";
      display:block;
      width:10px; height:6px;
      border-left:3px solid rgba(22,163,74,.95);
      border-bottom:3px solid rgba(22,163,74,.95);
      transform: translate(6px,6px) rotate(-45deg);
    }

    /* Result badge */
    .badge{
      font-family:var(--mono);
      font-weight:900;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(2,6,23,.10);
      background:rgba(2,6,23,.03);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .badge.good{ border-color:rgba(22,163,74,.25); background:rgba(22,163,74,.12); color:rgba(22,163,74,.95); }
    .badge.warn{ border-color:rgba(245,158,11,.25); background:rgba(245,158,11,.12); color:rgba(180,83,9,.95); }
    .badge.bad{  border-color:rgba(239,68,68,.25); background:rgba(239,68,68,.12); color:rgba(185,28,28,.95); }

    .twoCol{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:560px){ .twoCol{ grid-template-columns:1fr; } }

    .li{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 0;
      border-top:1px dashed rgba(2,6,23,.12);
    }
    .li:first-child{ border-top:none; padding-top:0; }
    .ico{
      width:22px; height:22px; border-radius:10px;
      background:rgba(183,156,255,.14);
      border:1px solid rgba(155,123,255,.22);
      flex:0 0 auto;
    }

    .footerNote{
      margin-top:10px;
      border-top:1px solid rgba(2,6,23,.08);
      padding-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
    }

    /* Mobile sticky action bar */
    .mobileActions{
      display:none;
      position:sticky;
      bottom:10px;
      z-index:10;
      gap:10px;
      padding:10px;
      border-radius:18px;
      border:1px solid rgba(2,6,23,.10);
      background:rgba(255,255,255,.85);
      backdrop-filter: blur(10px) saturate(160%);
      box-shadow: 0 16px 40px rgba(2,6,23,.12);
    }
    @media (max-width:980px){
      .mobileActions{ display:flex; }
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(2,6,23,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
      box-shadow:0 12px 30px rgba(0,0,0,.18);
      z-index:9999;
      opacity:0;
      transition:opacity .15s ease;
      max-width:min(92vw, 560px);
    }
    .toast.on{ opacity:1; }
  </style>
</head>

<body>
  <div class="top">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div style="min-width:0">
          <div class="brandTitle">Casual Anatomy: Risk Scan</div>
          <div class="brandSub">Interactive scan • © rara_illustra</div>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:10px;">
        <div class="pill" id="stagePill">STAGE: UPLOAD</div>
        <nav class="lang" aria-label="Language">
          <a class="langLink" href="../">RU</a>
          <a class="langLink active" href="./">EN</a>
        </nav>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: controls -->
      <section class="card">
        <div class="pad">
          <div class="h1">Check an item before you buy</div>
          <p class="p">
            Pick a category, upload <b>1–3 photos</bb>, and get a detailed review in about 20 seconds. 
            This isn’t AI and it isn’t a quality guarantee. It simply estimates risk based on what’s actually visible in the photos. 
          </p>

          <div class="field">
            <div class="label">Item category</div>
            <select id="categorySelect" aria-label="Item category">
              <option value="universal">All Types</option>
              <option value="clothing">Clothing</option>
              <option value="leather">Leather & Suede</option>
              <option value="bag">Bags & Accessories</option>
              <option value="shoes">Shoes</option>
            </select>
            <div class="small" id="categoryHint"></div>
          </div>

          <div class="uploader">
            <div class="drop" id="dropZone">
              <div class="btnrow">
                <button class="btn btnPrimary" id="btnPick" type="button">Add photos</button>
                <button class="btn btnGhost" id="btnDemo" type="button">Demo</button>
              </div>

              <div class="small">
                Limit: <b>1–3</b> photos. HEIC support depends on the browser. If it does not open, try it as JPG or PNG.
              </div>

              <input id="fileInput" type="file" accept="image/*" multiple />

              <div class="thumbs" id="thumbs" aria-label="Photo previews"></div>

              <div class="divider"></div>

              <div class="btnrow">
                <button class="btn btnPrimary" id="btnStart" type="button" disabled>Run Scan</button>
                <button class="btn" id="btnClear" type="button" disabled>Clear Photos</button>
                <button class="btn btnSmall" id="btnCopyLink" type="button">Copy Link</button>
              </div>

              <div class="small" id="hintText">
                If the seller won’t show the fabric or texture, and seams, that’s a red flag. The scan tells you what to ask for.
              </div>
            </div>
          </div>

          <div class="kpi">
            <div class="item">
              <div class="num" id="kpiPhotos">0</div>
              <div class="lbl">Photos</div>
            </div>

            <div class="item kpiWide">
              <div class="lbl" style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                <span>Rating</span>
                <span class="mono" id="kpiRating">—</span>
              </div>

              <div class="kpiScale" id="kpiScale" aria-label="Rating scale">
                <div class="kpiTrack"></div>
                <div class="kpiTicks" aria-hidden="true">
                  <span></span><span></span><span></span><span></span><span></span>
                </div>
                <div class="kpiMarker" id="kpiMarker" aria-hidden="true"></div>
              </div>

              <div class="kpiEnds">
                <span>not today</span>
                <span>wow</span>
              </div>
            </div>
          </div>

          <div class="panel" style="margin-top:12px">
            <div class="mono" style="font-weight:900; font-size:12px; color:rgba(2,6,23,.70)">Privacy & Terms</div>
            <div class="divider"></div>
            <div class="small">
              • Photos are processed <b>locally</b> in your browser: the site does not upload images to a server.<br>
              • Don’t upload personal data (faces, documents, addresses, payment QR codes).<br>
              • The result is a recommendation — not an expert assessment, proof of quality, or a guarantee. You decide whether to buy.<br>
              • By uploading photos, you confirm you have the right to use them (your own photos/screenshots or with the rightsholder’s permission).<br>
              • Rights to the concept, design, and copy belong to <b>© rara_illustra</b>.
            </div>
          </div>
        </div>
      </section>

      <section class="phone">
        <div class="phoneTop">
          <div class="mono" style="font-size:12px; color:rgba(2,6,23,.72)">
            CASUAL ANATOMY • <span id="phoneMode">Ready</span>
          </div>
          <div class="mono" style="font-size:12px; color:rgba(2,6,23,.55)">
            <span id="timer">0:00</span> / 0:20
          </div>
        </div>

        <div class="screen" id="screen">
          <div class="scanOverlay" id="scanOverlay"><div class="scanLine"></div></div>


          <div id="viewReady">
            <div class="heroImg" id="heroImg">
              <div class="heroOverlay" id="heroOverlayText">Upload 1–3 photos and tap Start.</div>
            </div>

            <div class="panel">
              <div class="badge" id="readyBadge">Scan profile: All Types</div>
              <div style="height:10px"></div>
              <div style="font-weight:950; font-size:20px">20-second photo check</div>
              <div class="small" id="readySubtitle" style="margin-top:8px"></div>
              <div style="height:12px"></div>
              <div class="btnrow">
                <button class="btn btnPrimary" id="btnStart2" type="button" disabled>START</button>
                <button class="btn btnSmall" id="btnShare" type="button">Share</button>
              </div>
            </div>

            <div class="footerNote">Works with any marketplace: you can upload screenshots from a product listing..</div>
          </div>


          <div id="viewScan" style="display:none">
            <div class="progressWrap">
              <div class="mono" style="font-size:12px; color:rgba(2,6,23,.65); display:flex; justify-content:space-between; gap:10px">
                <span id="scanTitle">Scan</span>
                <span id="pct" style="color:rgba(155,123,255,.95)">0%</span>
              </div>
              <div style="height:10px"></div>
              <div class="bar"><div id="barFill"></div></div>
              <div class="small" style="margin-top:10px" id="scanTip">Preparing…</div>
            </div>

            <div class="stepList" id="steps" style="margin-top:10px"></div>

            <div class="footerNote" id="decodeNote" style="display:none">
              Some photos couldn’t be decoded (often HEIC). The result was partially estimated using metadata.
            </div>
          </div>

          <div id="viewResult" style="display:none">
            <div class="panel">
              <div class="badge" id="levelBadge">RESULT</div>
              <div style="height:10px"></div>

              <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap">
                <div>
                  <div style="font-weight:950; font-size:24px" id="levelTitle">—</div>
                  <div class="small" style="margin-top:6px" id="levelSubtitle">—</div>
                </div>

                <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
                  <div class="pill" id="scorePill">SCORE: —</div>
                </div>
              </div>
            </div>

            <div class="panel">
              <div class="mono" style="font-size:12px; color:rgba(2,6,23,.65); margin-bottom:10px">What We Can See</div>
              <div id="obsList"></div>
            </div>

            <div class="twoCol">
              <div class="panel">
                <div class="mono" style="font-size:12px; color:rgba(2,6,23,.65); margin-bottom:10px">Quality Control</div>
                <div id="flagsList" class="small"></div>
              </div>
              <div class="panel">
                <div class="mono" style="font-size:12px; color:rgba(2,6,23,.65); margin-bottom:10px">No tricks. Just a smart buy</div>
                <div id="compliment" style="font-weight:950; font-size:16px; line-height:1.25"></div>
              </div>
            </div>

            <div class="panel">
              <div class="mono" style="font-size:12px; color:rgba(2,6,23,.65); margin-bottom:10px">
                Ready-to-Send Messages (EN + 中文)
              </div>
              <div id="sellerMsgs" class="small"></div>

              <div style="height:12px"></div>
              <div class="btnrow">
                <button class="btn" id="btnCopySeller" type="button">Copy for Seller</button>
                <button class="btn" id="btnShare2" type="button">Share</button>
                <button class="btn" id="btnBack" type="button">Back</button>
              </div>

              <div class="footerNote">© rara_illustra • Casual Anatomy • Marketplaces</div>
            </div>
          </div>


          <div class="mobileActions" aria-label="Actions">
            <button class="btn btnPrimary" id="btnPickMobile" type="button" style="flex:1">Add</button>
            <button class="btn" id="btnStartMobile" type="button" style="flex:1" disabled>Start</button>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>

    const MAX_PHOTOS = 3;

    const COMPLIMENTS = [
      "You’ve got a sharp eye. You spot what others miss.",
      "Ok bestie, I see the pause. We’re not getting seduced by the lighting today.",
      "You’re not buying the photo, you’re buying the construction. Period.",
      "Style is cute, but you’re here for quality. Love that for you.",
      "If they won’t show details, that’s the detail. Red flag, babe.",
      "You’re not picky, you’re precise. There’s a difference.",
      "I love that you’re choosing future. Your comfort, not the quick dopamine hit.",
      "You’re building a wardrobe that works, not a moment for the feed.",
      "Walking away is also a win. Very grown, very chic.",
      "You already know what you don’t want that’s clarity, bestie.",
      "Your standards are high, and we’re not negotiating them.",
      "You’re not falling for a pretty photo. You’re checking the facts.",
      "You don’t get hypnotized by the picture; you verify.",
      "This isn’t being picky, it’s knowing how to choose pieces that look good not just in photos, but in real life over time.",
      "You’re not overthinking. You just know what you need.",
      "You choose in a way you won’t regret later.",
      "I see you pausing. We’re not doing impulse buys today."
    ];

    const CATEGORIES = {
      universal: {
        label:"All Types",
        hint:"We’ll scan the photos: details, clarity, and where the trap might be.",
        readySubtitle:"The scan estimates photo-based risk and suggests what to ask the seller. So you can decide with confidence.",
        scanTitle:"Risk Scan",
        steps:[
          { key:"coverage", title:"Details", desc:"Do we have close-ups of the key areas?" },
          { key:"clarity",  title:"Clarity", desc:"Can we actually see texture and small details?" },
          { key:"consistency", title:"Consistency", desc:"Do the photos look like the same item?" },
          { key:"risk", title:"Photo Risk", desc:"Glare, overexposure, or filter." },
          { key:"seller", title:"What to Ask", desc:"We’ll draft messages for the seller (EN + 中文)." }
        ],
        flags:{
          no_details:"Missing close-ups of key areas — ask for close-up photos.",
          blurry:"The photos are blurry—easy to misjudge. Ask for clearer, higher-quality shots.",
          too_glossy:"There’s overexposure — the material and color may look different in real life.",
          inconsistent:"These look like photos from different sources. Ask for real photos of this exact item.",
          only_marketing:"Too perfect, but no useful details. Getting marketing vibes—not proof."
        },
        askPool:["close-up detail shots","daylight photos with no filters","inside-out photos"],
        sellerMessages:[
          {
            "en": "Hello! Could you please send a close-up photo of the item in natural daylight: material/edges/details?",
            "zh": "你好！可以发一下自然光的细节图吗：材质/边缘/细节近景。"
          },
          {
            "ru": "Пожалуйста, пришлите фото изнутри/обратной стороны (если есть).",
            "en": "Please send a photo of the inside-out/back side (if available).",
            "zh": "麻烦发一下内部/反面的照片（如果有的话）。"
          },
          {
            "en": "Hello! Can I get a close-up photo of the garment accessories (zipper/buckles/buttons) in daylight?",
            "zh": "你好！可以发一下五金细节近景吗（拉链/扣子/卡扣/连接处）？最好自然光。"
          },
          {
            "en": "Can I get a close-up photo of the handle/strap attachment points?",
            "zh": "可以拍一下手柄/肩带连接处近景吗？这是最受力的位置。"
          },
          {
            "en": "Please mention the bag's weight and dimensions in cm (width/height/depth).",
            "zh": "请问包的重量和实测尺寸（宽/高/厚，厘米）是多少？"
          },
          {
            "en": "Can I get a close-up photo of the zipper: zipper scoop/smoothness/any branding?",
            "zh": "可以拍一下拉链近景吗？拉链齿、顺滑度、是否有标识。"
          },
          {
            "en": "Does the plating on the garment wear off? Could you send a photo without overexposure so I can see the metal hue?",
            "zh": "五金电镀会不会掉色？可以不过曝拍一下看真实金属颜色吗？"
          },
          {
            "en": "Does the material have any smell? (sometimes it's important to understand the processing quality)",
            "zh": "材质有没有明显气味？（想了解工艺处理情况）"
          },
          {
            "en": "Accessories: dust bag/box/packaging? Can I get a photo of the set?",
            "zh": "有没有防尘袋/盒子/包装？可以拍一下配件吗？"
          },
          {
            "en": "If there are compartments/pockets, can I get a photo of how they are stitched and secured?",
            "zh": "如果有隔层/内袋，可以拍一下缝合和固定处近景吗？"
          },
          {
            "en": "Please check before shipping: are there any scratches, stitching misalignment, or stains?",
            "zh": "发货前麻烦检查：是否有划痕、走线歪、污渍等。"
          },
          {
            "en": "Can I get a photo of the bag held in hand to see how it 'holds' its shape?",
            "zh": "可以拎起来拍一下吗？想看包的挺括度和垂坠感。"
          }
        ]
      },
      clothing: {
        label:"Clothing",
        hint:"Fabric, seams, shape, symmetry.",
        readySubtitle:"If there are no close-ups of the fabric and seams, there’s a real risk you’re buying the wrong thing.",
        scanTitle:"Clothing Scan",
        steps:[
          { key:"coverage", title:"Fabric & Details", desc:"We check fabric, collar, cuffs, and hem." },
          { key:"clarity",  title:"Seams", desc:"Are the stitches and seam finish clearly visible?" },
          { key:"consistency", title:"Shape", desc:"Lines, pockets, fit — no warping or distortion." },
          { key:"risk", title:"Photo Risk", desc:"Editing, glare, and overexposure." },
          { key:"seller", title:"What to Ask", desc:"We’ll request fabric details (EN + 中文)." }
        ],
        flags:{
          no_details:"No close-ups of texture or edges. Here is risk of coated faux leather.",
          blurry:"Too blurry to judge the grain and edges.",
          too_glossy:"In real life it may look cheaper.",
          inconsistent:"The texture doesn’t match across photos — ask for real shots of this item.",
          only_marketing:"Looks heavily edited."
        },

        askPool:[
          "close-ups of seams",
          "photo of the tag",
          "inside-out seam finish"
        ],
        sellerMessages:[
          { en:"Hi! Could you send close-ups of the fabric and seams without filters?", zh:"你好！可以发一下面料和缝线近景吗？请用自然光、不加滤镜。" },
          { en:"Please send a photo of the care label and the inside-out/back side.", zh:"麻烦发一下成分标签和反面（内侧）照片。" },
          { en:"Could you send close-ups of the cuffs, hem, and collar so I can check the finishing?", zh:"可以发一下袖口/下摆/领口的近景吗？想确认做工细节。" },
          { en:"Could you show the inside-out seam finish?", zh:"可以拍一下内侧走线和收边的细节吗？比如锁边/包边/折边。" },
          { en:"Could you send a short video with no filters, showing the fabric and fit?", zh:"可以发一个5–10秒不加滤镜的视频吗？展示面料和版型。" },
          { en:"What’s the item’s weight? (It often hints at fabric's density (GSM).)", zh:"这件衣服大概多重？（重量能大致反映面料厚薄）" },
          { en:"Is the fabric itchy or see-through?", zh:"面料会扎/会透吗？可以如实说明一下穿着感受吗？" },
          { en:"Could you take a daylight photo next to a white sheet of paper?", zh:"可以自然光下放一张白纸对比拍照吗？想确认色差。" }
        ]
      },
      leather: {
        label:"Leather & Suede",
        hint:"Focus on texture, edges, and stitching.",
        readySubtitle:"Leather can look misleading in photos because of glare. Close-ups really matter.",
        scanTitle:"Leather & Suede Scan",
        steps:[
          { key:"coverage", title:"Texture", desc:"Do we see real texture—not filters?" },
          { key:"clarity",  title:"Edges & Stitching", desc:"Can we judge stitch quality and edge finishing?" },
          { key:"consistency", title:"Shape", desc:"Does the silhouette hold up? No warping, bubbles, or weird folds?" },
          { key:"risk", title:"Glare", desc:"Glare can hide texture and mask flaws." },
          { key:"seller", title:"What to ask", desc:"We’ll request honest photos and a short video." }
        ],
        flags:{
          no_details:"No close-ups of texture or edges — risk of coated faux leather.",
          blurry:"Too blurry to judge the grain and edges.",
          too_glossy:"Too shiny in real life it may look cheaper.",
          inconsistent:"The texture doesn’t match across photos — ask for real shots of this exact item.",
          only_marketing:"Looks heavily edited."
        },
        askPool:["close-up texture without glare","close-ups of edges and stitching","inside-out/lining photos"],
        sellerMessages:[
          { en:"Hi! Could you send a close-up of the texture/grain in daylight, no glare or filters?", zh:"你好！方便提供纹理（纹路／粒面）的自然光近景特写吗？请避免反光、勿使用滤镜" },
          { en:"Please send close-ups of the edges (including edge paint/finishing) and stitching (seams).", zh:"请提供边缘（封边／油边工艺）与缝线（接缝处）的清晰近景。" },
          { en:"Could you also share close-ups of the hardware details (e.g., zipper, snaps, buttons, buckles)", zh:"另请提供内里／衬里的近景，以及五金配件细节（如拉链、按扣、纽扣、搭扣等）特写。" }
        ]
      },
      bag: {
        label:"Bags & Accessoriess",
        hint:"Hardware, edge paint/piping, stitching, lining, and overall shape.",
        readySubtitle:"Bags most commonly fail on hardware quality and edge paint finish.",
        scanTitle:"Bag Inspection",
        steps:[
          { key:"coverage", title:"Clothing Hardware", desc:"Zippers, clasps, rings, strap attachments, and metal components." },
          { key:"clarity",  title:"Edge Paint & Piping", desc:"Clarity of edge paint finish, piping alignment, and adjacent stitching." },
          { key:"consistency", title:"Shape", desc:"Silhouette and symmetry." },
          { key:"risk", title:"Photo Quality Risks", desc:"Blurry details, overexposure, missing critical angles." },
          { key:"seller", title:"What to ask", desc:"System will auto-generate lining and edge detail requests (EN+中文)." }
        ],
        flags:{
          no_details:"No close-ups of hardware—critical quality indicators are missing.",
          blurry:"Insufficient clarity to assess edge paint finish and metal details.",
          too_glossy:"Color and material may look different in real life.",
          inconsistent:"Photos mismatched. Request authentic photos of this specific item.",
          only_marketing:"Overly stylized imagery lacks detail verification."
        },

        askPool:["close-ups of hardware details","edge paint and piping details","inside-out lining & inner seams"],
        sellerMessages: [
          { 
            en: "Hi! Could you please share close-up photos of hardware details (zipper, clasps, strap attachments) under natural daylight? Please avoid glare and filters.", 
            zh: "你好！方便提供五金配件（拉链、扣具、肩带连接件等）的自然光近景特写吗？请避免反光并勿使用滤镜。" 
          },
          { 
            en: "Please provide clear close-ups of edge paint finish and stitching — especially at corners and structural joints.", 
            zh: "请提供封边（油边）工艺、包边条及缝线细节的清晰近景，重点拍摄转角与结构接合处。" 
          },
          { 
            en: "Could you also share close-ups of the seam?", 
            zh: "另请提供内衬内部及接缝工艺特写（例如内衬与包身的缝合处）。" 
          },
          { 
            en: "Please capture close-up details of handle.", 
            zh: "请拍摄手柄与肩带连接处的细节特写，此为受力关键部位，对评估耐用性至关重要。" 
          },
          { 
            en: "Could you confirm included accessories (dust bag, box, packaging) and share a photo of the set?", 
            zh: "请确认所含配件（防尘袋、礼盒、包装等），并提供全套物品的实拍照片。" 
          },
          { 
            en: "Please clarify the return and exchange conditions.", 
            zh: "如商品实物与描述或图片所示存在差异，请说明具体的退换货政策。" 
          }
        ]
      },

      shoes: {
        label:"Shoes",
        hint:"Focus on the sole joint, glue, stitching, toe and heel shape, and insoles.",
        readySubtitle:"If there’s no photo of the sole joint, that’s a red flag.",
        scanTitle:"Shoe Scan",
        steps:[
          { key:"coverage", title:"Sole Joint", desc:"Do we have a close-up where the sole meets the upper?" },
          { key:"clarity",  title:"Seams & Glue", desc:"Can we see clean finishing — no glue residue, gaps, or crooked stitches?" },
          { key:"consistency", title:"Shape", desc:"Toe and heel: pair symmetry, no warping or deformation." },
          { key:"risk", title:"Photo Risk", desc:"Overexposed photos." },
          { key:"seller", title:"What to Ask", desc:"We’ll request joint close-ups and inside photos (EN + 中文)." }
        ],
        flags:{
          no_details:"No close-up of the sole joint — the biggest red flag for shoes.",
          blurry:"Too blurry to judge stitching and glue marks.",
          too_glossy:"Overexposure! Texture and material may look different in real life.",
          inconsistent:"These don’t look like the same pair, ask for real photos of this exact pair.",
          only_marketing:"Pretty shots, but no useful details."
        },
        askPool:["close-up of the sole-to-upper joint","close-ups of the toe and heel","inside-out photos"],
        sellerMessages:[
          { en:"Hi! Could you send a daylight close-up of the sole-to-upper joint?", zh:"你好！可以发一下鞋底与鞋面连接处的近景吗（侧面），最好自然光。" },
          { en:"Please send close-ups of the toe and heel.", zh:"麻烦发一下鞋头和鞋跟近景（形状和对称性）。" },
          { en:"Could you show the inner stitching and finishing?", zh:"可以发一下鞋内细节吗：鞋垫、内里做工和缝线细节。" },
          { en:"Are there visible glue marks? Please send a photo without glare.", zh:"连接处有没有明显溢胶？可以不过曝实拍一下吗？" },
          { en:"Could you show a toe bend test?", zh:"可以拍一下鞋头弯折效果吗？看材质折痕情况。" },
          { en:"Could you send a short 5–10 sec video of seams, joint, and inside?", zh:"可以发一个5–10秒视频吗？重点拍一下接缝/连接处/鞋内。" },
          { en:"Is the heel reinforced? Please show the heel counter.", zh:"后跟有加固吗？可以拍一下后跟内侧吗？" },
          { en:"Before shipping, please check pair symmetry, scratches, defects.", zh:"发货前麻烦检查：两只鞋是否对称，有无划痕/瑕疵。" },
          { en:"What is the lining material? Please send a photo and a short description.", zh:"内里/衬里是什么材质？可以拍照并简单说明吗？" },
          { en:"Please confirm the return/exchange policy if it doesn’t fit.", zh:"如果尺码不合适，退换货规则是什么？" }
        ]
      }
    };


    const el = (id)=>document.getElementById(id);

    const fileInput = el("fileInput");
    const btnPick = el("btnPick");
    const btnPickMobile = el("btnPickMobile");
    const dropZone = el("dropZone");
    const thumbs = el("thumbs");

    const btnStart = el("btnStart");
    const btnStart2 = el("btnStart2");
    const btnStartMobile = el("btnStartMobile");
    const btnClear = el("btnClear");
    const btnDemo = el("btnDemo");
    const btnCopyLink = el("btnCopyLink");

    const stagePill = el("stagePill");
    const phoneMode = el("phoneMode");
    const timerEl = el("timer");

    const categorySelect = el("categorySelect");
    const categoryHint = el("categoryHint");
    const readyBadge = el("readyBadge");
    const readySubtitle = el("readySubtitle");

    const heroImg = el("heroImg");
    const heroOverlayText = el("heroOverlayText");

    const scanTitle = el("scanTitle");
    const scanOverlay = el("scanOverlay");
    const pct = el("pct");
    const barFill = el("barFill");
    const scanTip = el("scanTip");
    const stepsEl = el("steps");
    const decodeNote = el("decodeNote");

    const viewReady = el("viewReady");
    const viewScan = el("viewScan");
    const viewResult = el("viewResult");

    const levelBadge = el("levelBadge");
    const levelTitle = el("levelTitle");
    const levelSubtitle = el("levelSubtitle");
    const scorePill = el("scorePill");
    const obsList = el("obsList");
    const flagsList = el("flagsList");
    const complimentEl = el("compliment");
    const sellerMsgs = el("sellerMsgs");

    const btnCopySeller = el("btnCopySeller");
    const btnShare = el("btnShare");
    const btnShare2 = el("btnShare2");
    const btnBack = el("btnBack");

    const kpiPhotos = el("kpiPhotos");
    const kpiRating = el("kpiRating");
    const kpiMarker = el("kpiMarker");

    const toastEl = el("toast");


    let filesState = [];
    let previewUrls = [];
    let demoMode = false;
    let activeCategoryKey = "universal";


    const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
    const fmtTime = (sec)=>`0:${String(Math.max(0,Math.floor(sec))).padStart(2,"0")}`;

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("on");
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>toastEl.classList.remove("on"), 1600);
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function revokePreviews(){
      previewUrls.forEach((u)=>{ try{ URL.revokeObjectURL(u); }catch{} });
      previewUrls = [];
    }

    function isImageFile(f){
      if(!f) return false;
      if(f.type && f.type.startsWith("image/")) return true;
      const name = (f.name || "").toLowerCase();
      if(/\.(jpg|jpeg|png|webp|heic|heif|gif|bmp)$/i.test(name)) return true;
      return false;
    }

    function setButtons(){
      const ok = filesState.length >= 1 && filesState.length <= MAX_PHOTOS;
      btnStart.disabled = !ok;
      btnStart2.disabled = !ok;
      btnStartMobile.disabled = !ok;
      btnClear.disabled = (filesState.length === 0 && !demoMode);
    }

    function updateKpi(meta){
      const clarityValue = (typeof meta === "number") ? meta : meta?.clarity;
      const scoreValue   = (typeof meta === "object" && meta) ? meta.score : undefined;
      const levelValue   = (typeof meta === "object" && meta) ? meta.level : undefined;

      kpiPhotos.textContent = String(filesState.length);

      if(filesState.length === 0){
        kpiRating.textContent = "—";
        kpiMarker.classList.remove("on");
        return;
      }

      const cov =
        filesState.length === 1 ? 0.38 :
        filesState.length === 2 ? 0.62 : 0.84;

      let v;
      if(typeof scoreValue === "number"){
        v = clamp(scoreValue / 100, 0, 1);
      } else {
        const c = (typeof clarityValue === "number") ? clarityValue : 0.52;
        v = clamp(0.55*c + 0.45*cov, 0, 1);
      }

      let label = "OK";
      if(levelValue === "NOT TODAY") label = "Not today";
      else if(levelValue === "WOW") label = "THIS IS IT!";
      else if(v < 0.28) label = "Not today";
      else if(v < 0.48) label = "Sketchy";
      else if(v < 0.85) label = "OK";
      else label = "THIS IS IT!";

      kpiRating.textContent = label;
      kpiMarker.classList.add("on");
      kpiMarker.style.left = `${Math.round(v * 100)}%`;
    }

    function getCategory(){ return CATEGORIES[activeCategoryKey] || CATEGORIES.universal; }

    function applyCategoryUI(){
      const cat = getCategory();
      categoryHint.textContent = cat.hint;
      readyBadge.textContent = `Scan profile: ${cat.label}`;
      readySubtitle.textContent = cat.readySubtitle;
      scanTitle.textContent = cat.scanTitle;
      heroOverlayText.textContent = (filesState.length ? "Ready. Tap START to see the scan result." : "Upload 1–3 photos and tap START");
      const liveOverlay = document.getElementById("heroOverlay");
      if(liveOverlay) liveOverlay.textContent = heroOverlayText.textContent;
    }

    categorySelect.addEventListener("change", ()=>{
      activeCategoryKey = categorySelect.value;
      applyCategoryUI();
      toReady();
    });

    function toReady(){
      phoneMode.textContent = "Ready";
      stagePill.textContent = "STAGE: UPLOAD";
      viewReady.style.display = "";
      viewScan.style.display = "none";
      viewResult.style.display = "none";
      scanOverlay.classList.remove("on");
      timerEl.textContent = "0:00";
      decodeNote.style.display = "none";
    }
    function toScan(){
      phoneMode.textContent = "Scan";
      stagePill.textContent = "STAGE: SCAN";
      viewReady.style.display = "none";
      viewScan.style.display = "";
      viewResult.style.display = "none";
      scanOverlay.classList.add("on");
      decodeNote.style.display = "none";
    }
    function toResult(){
      phoneMode.textContent = "Result";
      stagePill.textContent = "STAGE: RESULT";
      viewReady.style.display = "none";
      viewScan.style.display = "none";
      viewResult.style.display = "";
      scanOverlay.classList.remove("on");
    }

    function renderThumbs(){
      revokePreviews();
      thumbs.innerHTML = "";

      const hero = heroImg;
      hero.innerHTML = "";
      const heroChild = document.createElement("div");
      heroChild.className = "heroOverlay";
      heroChild.id = "heroOverlay";
      heroChild.textContent = heroOverlayText.textContent;

      if(filesState.length){
        const url = URL.createObjectURL(filesState[0]);
        previewUrls.push(url);
        const img = document.createElement("img");
        img.src = url;
        img.alt = "preview";
        hero.appendChild(img);
      }
      hero.appendChild(heroChild);

      filesState.forEach((f, idx)=>{
        const url = URL.createObjectURL(f);
        previewUrls.push(url);

        const box = document.createElement("div");
        box.className = "thumb";
        box.innerHTML = `
          <img src="${url}" alt="preview ${idx+1}" />
          <div class="x" title="Remove">×</div>
        `;
        box.querySelector(".x").addEventListener("click", ()=>{
          filesState.splice(idx, 1);
          demoMode = false;
          renderThumbs();
          updateKpi();
          setButtons();
          applyCategoryUI();
        });
        thumbs.appendChild(box);
      });

      applyCategoryUI();
    }

    function addFiles(newFiles){
      demoMode = false;

      const filtered = newFiles.filter(isImageFile);
      if(filtered.length === 0){
        toast("No images detected. Add JPG/PNG/WEBP (HEIC depends on the browser).");
        return;
      }

      const merged = [...filesState, ...filtered];
      if(merged.length > MAX_PHOTOS){
        toast(`Limit is ${MAX_PHOTOS} photos. Extra files were not added.`);
      }
      filesState = merged.slice(0, MAX_PHOTOS);

      renderThumbs();
      updateKpi();
      setButtons();
    }

    function openPicker(){
      fileInput.click();
    }

    btnPick.addEventListener("click", openPicker);
    btnPickMobile.addEventListener("click", openPicker);

    heroImg.addEventListener("click", ()=>{
      if(filesState.length === 0) openPicker();
    });

    fileInput.addEventListener("change", (e)=>{
      const list = Array.from(e.target.files || []);
      addFiles(list);
      fileInput.value = "";
    });

    dropZone.addEventListener("dragover", (e)=>{ e.preventDefault(); });
    dropZone.addEventListener("drop", (e)=>{
      e.preventDefault();
      const list = Array.from(e.dataTransfer?.files || []);
      addFiles(list);
    });

    btnClear.addEventListener("click", ()=>{
      filesState = [];
      demoMode = false;
      renderThumbs();
      updateKpi();
      setButtons();
      toReady();
    });

    btnCopyLink.addEventListener("click", async ()=>{
      const url = location.href;
      try{
        await navigator.clipboard.writeText(url);
        toast("Link copied");
      }catch{
        const ta = document.createElement("textarea");
        ta.value = url;
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); toast("Link copied"); }
        catch{ toast("Couldn’t copy"); }
        finally{ ta.remove(); }
      }
    });

    async function sharePage(extraText=""){
      const text = extraText || "Casual Anatomy Scan — a quick photo-based risk scan";
      try{
        if(navigator.share){
          await navigator.share({ title:"Casual Anatomy: Risk Scan", text, url:location.href });
        } else {
          await navigator.clipboard.writeText(`${text}\n${location.href}`);
          toast("Copied for sharing");
        }
      }catch{
        toast("Couldn’t share");
      }
    }
    btnShare.addEventListener("click", ()=>sharePage());
    btnShare2.addEventListener("click", ()=>sharePage());

    async function makeDemoImageBlob(){
      const c = document.createElement("canvas");
      c.width = 900; c.height = 600;
      const g = c.getContext("2d");

      const grd = g.createLinearGradient(0,0,900,600);
      grd.addColorStop(0,"#f2edff");
      grd.addColorStop(1,"#ffffff");
      g.fillStyle = grd; g.fillRect(0,0,900,600);

      g.fillStyle = "rgba(155,123,255,.18)";
      for(let i=0;i<10;i++){
        g.beginPath();
        g.arc(120+i*72, 130+(i%2)*36, 68, 0, Math.PI*2);
        g.fill();
      }

      g.fillStyle = "#0f172a";
      g.font = "900 44px system-ui";
      g.fillText("Casual Anatomy: Risk Scan", 60, 365);
      g.fillStyle = "rgba(15,23,42,.70)";
      g.font = "600 22px system-ui";
      g.fillText("Demo image (local scan)", 60, 410);

      return await new Promise((res)=>c.toBlob(res, "image/jpeg", 0.92));
    }

    btnDemo.addEventListener("click", async ()=>{
      demoMode = true;
      const blob = await makeDemoImageBlob();
      const demoFile = new File([blob], "demo-casual-anatomy.jpg", { type:"image/jpeg", lastModified: Date.now() });
      filesState = [demoFile];
      renderThumbs();
      updateKpi();
      setButtons();
      toReady();
    });

    function seedFromFiles(files, categoryKey){
      let s = 2166136261;
      const mix = (n)=>{ s ^= n; s = Math.imul(s, 16777619); s >>>= 0; };
      files.forEach((f)=>{
        const str = `${f.name}|${f.size}|${f.lastModified}`;
        for(let i=0;i<str.length;i++) mix(str.charCodeAt(i));
      });
      for(let i=0;i<categoryKey.length;i++) mix(categoryKey.charCodeAt(i));
      if(demoMode) mix(777);
      return s >>> 0;
    }
    function mulberry32(a){
      return function(){
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    function pick(rng, arr){ return arr[Math.floor(rng() * arr.length)]; }

    function shuffleWithRng(arr, rng){
      const a = [...arr];
      for(let i=a.length-1; i>0; i--){
        const j = Math.floor(rng() * (i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function getAdviceSeed(ctx){
      ctx = ctx || {};
      var s = "";

      if (ctx.seed != null) s = String(ctx.seed);
      else if (ctx.photoHash != null) s = String(ctx.photoHash);
      else if (ctx.fingerprint != null) s = String(ctx.fingerprint);
      else if (typeof filesState !== "undefined" && filesState && filesState.length){
        s = filesState.map(function(f){
          return (f && (f.hash || f.name)) ? (f.hash || f.name) : "";
        }).join("|");
      } else {
        s = "default";
      }

      return s;
    }

    function hashToInt(str){
      let h = 2166136261;
      for (let i=0; i<str.length; i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }

    function pickOne(seedStr, salt, arr){
      if(!arr || !arr.length) return null;
      const n = hashToInt(seedStr + "|" + salt);
      return arr[n % arr.length];
    }

      const POOLS_QA = {
        diagnosis: {
          risky: [
            { k:"dx_risk", t:"High risk", d:"Without extra details it’s easy to miss something." },
            { k:"dx_no", t:"Not today", d:"Right now this looks more like marketing than a well-made item." }
          ],
          ok: [
            { k:"dx_ok", t:"A few questions", d:"Looks fine, but I’d still verify a couple of details with the seller." },
            { k:"dx_mid", t:"A few questions", d:"Could be a yes, let’s request the right close-ups." }
          ],
          expensive: [
            { k:"dx_good", t:"Looks premium", d:"If the seller doesn’t dodge the details, this could be a strong buy." },
            { k:"dx_conf", t:"Feels expensive", d:"No obvious red flags. If it’s a dupe — at least it’s trying." }
          ]
        },

        actions: {
          lowCoverage: [
            { k:"cov1", t:"Not enough detail shots", d:"Add 1–2 close-ups so seams are visible." }
          ],
          lowClarity: [
            { k:"clr1", t:"Low clarity", d:"Ask for a closer photo." }
          ],
          glossy: [
            { k:"gl1", t:"Glare", d:"Ask for a daylight photo near a window, no filters, no overexposure." }
          ],
          lowConsistency: [
            { k:"con1", t:"Photos don’t match", d:"Ask for real photos of the same item (same background/light/angles)." }
          ],
          highRisk: [
            { k:"rk1", t:"Too much risk", d:"Without extra photos it’s better to skip. Either they show details or we pass." }
          ],
          midRisk: [
            { k:"rk2", t:"Medium risk", d:"Looks nice, but not informative. One or two useful close-ups will decide it." }
          ]
        },

        checks: [
          { k:"chk1", t:"Markers", d:"A close-up of edges, joints, and seams is a place where marketing ends and and reality begins." },
          { k:"chk2", t:"Color & Material", d:"Check color and texture under daylight" },
          { k:"chk3", t:"Fast Test", d:"5–10 second video with no filters." },
          { k:"chk4", t:"Answers", d:"A reasonable seller won’t mind showing the inside and close-up details. That’s a completely normal request." }
        ],

        final: {
          risky: [
            "If the seller won’t send details, skip it.",
            "If they hide the details, there’s usually a reason. Don’t gamble."
          ],
          ok: [
            "Looks okay, but I wouldn’t relax without the control shots.",
            "Not a miss, not a hit."
          ],
          expensive: [
            "It’s a yes right now, not a ‘let me think’.",
            "Honestly? Green flag. If they’ll send detail pics, go for it."
          ]
        }
      };


      function buildEditorialAdvice(category, ctx, level){
        const seed = getAdviceSeed(ctx);

        const bucket =
          level === "WOW" ? "expensive" :
          level === "OK"   ? "ok" : "risky";

        const picks = [];

        picks.push(pickOne(seed, "dx", POOLS_QA.diagnosis[bucket]));

        const lowCoverage = (ctx.coverage < 0.60) || (typeof filesState !== "undefined" && filesState.length === 1);
        const lowClarity = ctx.clarity < 0.40;
        const lowConsistency = (ctx.consistency < 0.45) && (typeof filesState !== "undefined" && filesState.length >= 2);
        const glossy = !!ctx.glossy;

        if (lowCoverage) picks.push(pickOne(seed, "act_cov", POOLS_QA.actions.lowCoverage));
        if (lowClarity) picks.push(pickOne(seed, "act_clr", POOLS_QA.actions.lowClarity));
        if (glossy) picks.push(pickOne(seed, "act_gl", POOLS_QA.actions.glossy));
        if (lowConsistency) picks.push(pickOne(seed, "act_con", POOLS_QA.actions.lowConsistency));

        if (ctx.riskScore >= 0.55) picks.push(pickOne(seed, "act_rk_hi", POOLS_QA.actions.highRisk));
        else if (ctx.riskScore >= 0.25) picks.push(pickOne(seed, "act_rk_mid", POOLS_QA.actions.midRisk));

        picks.push(pickOne(seed, "chk", POOLS_QA.checks));

        const out = [];
        const seen = new Set();
        for (const it of picks){
          if (!it || !it.k || seen.has(it.k)) continue;
          seen.add(it.k);
          out.push({ t: it.t, d: it.d });
          if (out.length >= 4) break; 
        }


        const final = pickOne(seed, "final", POOLS_QA.final[bucket]) || "OK.";

        return { tips: out, final };
      }


    function buildObservations(category, ctx, rng){
      const seed = getAdviceSeed(ctx);

      // helpers
      const addPool = (arr, into)=>{ if(Array.isArray(arr)) into.push(...arr.filter(Boolean)); };
      const pickStable = (salt, arr)=> pickOne(seed, salt, arr) || (arr && arr[0]) || "";
      const uniq = (arr)=>{
        const out = [];
        const seen = new Set();
        for(const x of arr){
          const k = String(x || "").trim();
          if(!k || seen.has(k)) continue;
          seen.add(k);
          out.push(k);
        }
        return out;
      };

      const band =
        ctx.riskScore >= 0.55 ? "HIGH" :
        ctx.riskScore >= 0.25 ? "MID"  : "LOW";

      const lowCoverage = (ctx.coverage < 0.60) || (typeof filesState !== "undefined" && filesState.length === 1);
      const lowClarity  = ctx.clarity < 0.45;
      const lowConsistency = (ctx.consistency < 0.45) && (typeof filesState !== "undefined" && filesState.length >= 2);
      const glossy = !!ctx.glossy;

      const VIS_POOLS = {
        lowCoverage: [
          "We can’t verify anything from this. Add angles, add texture, add seams.",
          "Close-ups or it won't happen.",
          "This is a photo, not proof. Where are the details?",
          "No close-ups in the control zones: seams, edges, joins. Zoom me in."
        ],
        lowClarity: [
          "This isn’t inspection-friendly. Ask for high-res detail pics.",
          "Zoom in and it falls apart. That’s your sign.",
          "It’s giving ‘aesthetic blur’ — not helpful. Need crisp close-ups.",
          "Easy to fall in love with this photo — impossible to verify it. Ask for another one."
        ],
        glossy: [
          "Studio shine is doing the most. Need daylight, no glare.",
          "The highlights are eating the texture.",
          "If the light is blinding, the texture is missing.",
          "The shine is loud. The details are quiet. Fix that."
        ],
        lowConsistency: [
          "One pic says A, the next pic says B. That’s a problem.",
          "I’m not convinced these are the same item.",
          "Different backgrounds, different lighting, different vibes — suspicious.",
          "The stitching looks different across shots. We need confirm with close-ups."
        ],
        ok: [
          "The details are doing the talking here.",
          "You can zoom and it still holds up. Nice.",
          "This is a ‘yes, we can verify’ situation.",
          "OLighting is decent and details are visible — good sign."
        ]
      };

      let visCandidates = [];
      if (lowCoverage) addPool(VIS_POOLS.lowCoverage, visCandidates);
      if (lowClarity) addPool(VIS_POOLS.lowClarity, visCandidates);
      if (glossy) addPool(VIS_POOLS.glossy, visCandidates);
      if (lowConsistency) addPool(VIS_POOLS.lowConsistency, visCandidates);
      if (visCandidates.length === 0) addPool(VIS_POOLS.ok, visCandidates);

      visCandidates = uniq(visCandidates);
      const visLine = pickStable("obs_vis", visCandidates);

      const RISK_POOLS = {
        LOW: [
          "Low risk vibe: if the seller stays responsive, you’re good.",
          "No obvious traps in the pics. That’s a good start.",
          "Low risk. if price and terms are good, this looks like a candidate.",
          "Photos hold up on zoom — that’s a win.."
        ],
        MID: [
          "It’s a soft maybe. One more close-up could flip it to yes.",
          "We’re in ‘ask for details’ territory.",
          "This could be fine but don’t buy blind. Get the control shots.",
          "Not a no, not a yes. We just need proof pics."
        ],
        HIGH: [
          "Too many red flags. I wouldn’t recommend buying without extra checks.",
          "If the seller won’t provide normal detail shots that’s an answer. High risk.",
          "Too many red flags in the photos without extra checks, I wouldn’t gamble on this.",
          "Looks suspicious right now. The photos aren’t inspection-friendly’."
        ]
      };

      const riskLine =
        band === "HIGH" ? pickStable("obs_risk_high", RISK_POOLS.HIGH) :
        band === "MID"  ? pickStable("obs_risk_mid",  RISK_POOLS.MID)  :
                          pickStable("obs_risk_low",  RISK_POOLS.LOW);

      const TIP_POOLS = {
        universal: [
          "Too perfect, but no details — I’m getting ‘Marketing No. 5’ perfume notes, not quality.",
          "Close-ups are the truth. If we can’t zoom, we can’t trust.",
          "Daylight is the lie detector.",
          "A normal seller will show the inside and details. If they get weird about it… that’s the answer.",
          "A 5–10 sec no-filter video clears 50% of the drama instantly.",
          "Problem zones: edges, corners, joins. Zoom there and the truth appears.",
          "No close-ups? No proof. Simple math.",
          "If the lighting is doing the most, the truth is doing the least.",
          "One pretty pic is not a quality certificate, bestie.",
          "Show me the stitching or I’m emotionally unavailable.",
          "If it’s ‘don’t zoom,’ it’s ‘don’t buy.’",
          "They’re selling a fantasy, not a product. Ask for proof pics.",
          "Close-ups or it didn’t happen."
        ],
        color: [
          "Daylight only. Ring light is a paid actor.",
          "Ask for ‘no beauty mode’ — we’re not buying a filter.",
          "If it’s ‘cream’ in one pic and ‘beige’ in another… we need proof."

        ],
        detail: [
          "Pretty pics are cute. Detail pics are proof.",
          "Ask for inside seams and edges that’s where quality lives or dies.",
          "Three close-ups > ten mood shots. Always.",
          "If they can’t show the inside, we don’t show up with money.",
          "More angles, less guessing. We’re not gambling today.",
          "Ask for the ‘unflattering’ angle — that’s the honest ."
        ],
        marketing: [
          "Catalog beauty doesn’t answer ‘how it’s made’. Ask for the seam.",
          "A single seam close-up will end the mystery real quick.",
          "Stop selling me vibes — show me the stitching.",
          "Catalog pics are a trailer. I need the full movie: seams, edges, inside.",
          "This looks retouched into another universe. Ask for raw daylight shots.",
          "If they can’t show a seam, they can’t sell me a dream."
        ],
        bag: [
          "Corners don’t lie — zoom there and you’ll know.",
          "Attachment points are the stress test. Need close-ups.",
          "Ask for the zipper running on video — if it sticks, we pass.",
          "Show the rivets and stitching up close — that’s the real quality check."
        ],
        shoes: [
          "For shoes, the key is a close-up of the sole-to-upper joint. If it’s missing, request it.",
          "Ask for toe and heel photos — pair symmetry tells you a lot instantly.",
          "Ask for a toe-bend photo. We need to see how the material creases.",
          "Inside shots matter — lining, stitching, finishing. Show it.",
          "Toe bend test: show the crease pattern."

        ],
        clothing: [
          "Ask for the care label and inside-out photos.",
          "Ask for close-ups of the cuffs, hem, and collar.",
          "Too perfect with no details. I feel ‘Marketing No. 5’ vibes, not quality.",
          "Ask for a flat-lay photo with no folds, it reveals shape and distortion.",
          "If there’s print, ask for close-ups and a photo of the back side."
        ],
        highRisk: [
          "If they answer vaguely, skip it. Options are plenty - your nerves aren’t.",
          "If they hide details, there’s a reason. Don’t risk it.",
          "Don’t buy on hope. Buy on proof.",
          "If they dodge questions, that’s your answer. Pass.",
          "No details, no clarity, no deal.",
          "If it’s excuses instead of photos, we move on.",
          "Don’t gamble with your money.",
          "If they won’t show it, you won’t buy it. Simple.",
          "We’re not doing ‘maybe it’ll be fine’ purchases today."
        ],
        midRisk: [
          "Medium risk. Ask for one honest seam close-up. It’ll clarify everything.",
          "Ask for a short no-filter video. It is faster than a back-and-forth chat.",
          "Doubts are cured by details, not persuasion. Ask for the details.",
          "One clean close-up can turn this from ‘maybe’ to ‘yes.’",
          "A 5–10 sec video beats 20 messages. Every time.",
          "Don’t let words sell it. Let close-ups prove it.",
          "If it’s medium risk, the move is simple: request proof pics.",
        ],
        lowRisk: [
          "If the price is right, this looks convincing so far.",
          "Green flag energy. We can proceed.",
          "If the terms are good, you’re safe to proceed.",
          "No obvious traps that’s already a win.",
          "If the seller stays responsive, this is a yes.",
          "This one isn’t making me nervous. Proceed."
        ]
      };

      let tipCandidates = [];
      if (lowCoverage) addPool(TIP_POOLS.detail, tipCandidates);
      if (lowClarity) addPool(TIP_POOLS.detail, tipCandidates);
      if (glossy) addPool(TIP_POOLS.color, tipCandidates);
      if (lowConsistency) addPool(TIP_POOLS.marketing, tipCandidates);

      if (band === "HIGH") addPool(TIP_POOLS.highRisk, tipCandidates);
      if (band === "MID") addPool(TIP_POOLS.midRisk, tipCandidates);
      if (band === "LOW") addPool(TIP_POOLS.lowRisk, tipCandidates);

      if (activeCategoryKey === "bag") addPool(TIP_POOLS.bag, tipCandidates);
      if (activeCategoryKey === "shoes") addPool(TIP_POOLS.shoes, tipCandidates);
      if (activeCategoryKey === "clothing") addPool(TIP_POOLS.clothing, tipCandidates);

      addPool(TIP_POOLS.universal, tipCandidates);

      tipCandidates = uniq(tipCandidates);
      const tipLine = pickStable("obs_tip", tipCandidates);

      const askLine = `I would ask for ${ctx.ask}.`;

      return [visLine, riskLine, tipLine, askLine];
    }

    function buildStepsUI(category){
      stepsEl.innerHTML = "";
      category.steps.forEach((s, idx)=>{
        const row = document.createElement("div");
        row.className = "step";
        row.innerHTML = `
          <div style="display:flex; gap:10px; align-items:center; min-width:0">
            <div class="chip">${idx+1}. ${escapeHtml(s.title)}</div>
            <div class="desc">${escapeHtml(s.desc)}</div>
          </div>
          <div class="tick" id="tick-${s.key}"></div>
        `;
        stepsEl.appendChild(row);
      });
    }
    function setTick(key, on){
      const node = document.getElementById(`tick-${key}`);
      if(!node) return;
      node.classList.toggle("on", !!on);
    }

    async function decodeToCanvas(file, targetW=240){
      try{
        if("createImageBitmap" in window){
          const bmp = await createImageBitmap(file).catch(()=>null);
          if(bmp){
            const w = targetW;
            const h = Math.max(120, Math.round(targetW * (bmp.height / bmp.width)));
            const c = document.createElement("canvas");
            c.width = w; c.height = Math.min(260, h);
            const ctx = c.getContext("2d", { willReadFrequently:true });
            ctx.drawImage(bmp, 0, 0, c.width, c.height);
            try{ bmp.close && bmp.close(); }catch{}
            return { canvas:c, decodeFailed:false };
          }
        }
      }catch{}

      const url = URL.createObjectURL(file);
      try{
        const img = new Image();
        img.decoding = "async";
        img.src = url;
        await new Promise((resolve, reject)=>{
          img.onload = ()=>resolve();
          img.onerror = ()=>reject(new Error("img load failed"));
        });
        const w = targetW;
        const h = Math.max(120, Math.round(targetW * (img.height / img.width)));
        const c = document.createElement("canvas");
        c.width = w; c.height = Math.min(260, h);
        const ctx = c.getContext("2d", { willReadFrequently:true });
        ctx.drawImage(img, 0, 0, c.width, c.height);
        return { canvas:c, decodeFailed:false };
      }catch{
        return { canvas:null, decodeFailed:true };
      }finally{
        URL.revokeObjectURL(url);
      }
    }

    async function computeMetrics(file){
      const { canvas, decodeFailed } = await decodeToCanvas(file, 260);
      if(decodeFailed || !canvas){
        return {
          mean:140, contrast:20,
          highlightRatio:0.10,
          glossyRatio:0.10,
          sharpness:6,
          decodeFailed:true
        };
      }

      const ctx = canvas.getContext("2d", { willReadFrequently:true });
      const { data } = ctx.getImageData(0,0,canvas.width,canvas.height);

      let sum=0, sum2=0, n=0;
      let hi=0, satHi=0, grad=0;

      const step = 4;
      for(let y=0;y<canvas.height;y+=step){
        for(let x=0;x<canvas.width;x+=step){
          const i = (y*canvas.width + x) * 4;
          const r = data[i], g = data[i+1], b = data[i+2];

          const lum = 0.2126*r + 0.7152*g + 0.0722*b;
          sum += lum; sum2 += lum*lum; n++;

          if(lum > 235) hi++;

          const max = Math.max(r,g,b);
          const min = Math.min(r,g,b);
          const sat = max === 0 ? 0 : (max-min)/max;

          if(lum > 230 && sat < 0.18) satHi++;

          if(x+step < canvas.width){
            const j = (y*canvas.width + (x+step)) * 4;
            const r2 = data[j], g2 = data[j+1], b2 = data[j+2];
            const lum2 = 0.2126*r2 + 0.7152*g2 + 0.0722*b2;
            grad += Math.abs(lum2 - lum);
          }
        }
      }

      const mean = sum / n;
      const variance = Math.max(0, (sum2/n) - mean*mean);
      const contrast = Math.sqrt(variance);
      const highlightRatio = hi / n;
      const glossyRatio = satHi / n;
      const sharpness = grad / n;

      return { mean, contrast, highlightRatio, glossyRatio, sharpness, decodeFailed:false };
    }

    function classify(signals, rng){
      const { coverage, clarity, consistency, riskScore } = signals;

      let score =
        48
        + (coverage - 0.52) * 46
        + (clarity  - 0.52) * 56
        + (consistency - 0.55) * 26
        - (riskScore) * 58;

      if(activeCategoryKey === "leather" && riskScore > 0.40) score -= 6;
      if(activeCategoryKey === "shoes" && coverage < 0.62) score -= 8;

      score += (rng() - 0.5) * 14;
      score = Math.round(clamp(score, 0, 100));

      let level = "OK";
      if(score >= 86) level = "WOW";
      if(score < 56) level = "NOT TODAY";

      let confidence = "MEDIUM";
      if(coverage >= 0.84 && clarity >= 0.68 && riskScore <= 0.26) confidence = "HIGH";
      if(coverage <= 0.50 || clarity <= 0.40 || riskScore >= 0.62) confidence = "LOW";

      return { score, level, confidence };
    }

    function badgeClass(level){
      if(level === "WOW") return "good";
      if(level === "OK") return "warn";
      return "bad";
    }

    function pickSellerMessages(category, rng){
      return shuffleWithRng(category.sellerMessages, rng).slice(0, 3);
    }

    async function runScan(){
      if(filesState.length < 1){
        toast("Add at least 1 photo");
        return;
      }

      const category = getCategory();
      const seed = seedFromFiles(filesState, activeCategoryKey);
      const rng = mulberry32(seed);

      toScan();
      buildStepsUI(category);

      category.steps.forEach(s=>setTick(s.key,false));
      pct.textContent = "0%";
      barFill.style.width = "0%";
      timerEl.textContent = "0:00";
      scanTip.textContent = pick(rng, [
        "Hunting for filters and blur…",
        "Zoom-checking seams and edges…",
        "Scanning for red-flag lighting…",
        "Building your proof checklist…"

      ]);

      const metricsPromise = Promise.all(filesState.map(f=>computeMetrics(f)));

      const start = performance.now();
      const duration = 7800;

      const moments = [
        { t:0.18, key:category.steps[0]?.key, tip:"Checking for enough close-ups and detail shots…" },
        { t:0.38, key:category.steps[1]?.key, tip:"Estimating clarity…" },
        { t:0.58, key:category.steps[2]?.key, tip:"Zoom-checking the details…" },
        { t:0.78, key:category.steps[3]?.key, tip:"Scanning for glare, overexposure, and editing…" },
        { t:0.92, key:category.steps[4]?.key, tip:"Preparing questions for the seller…" }
      ].filter(m=>m.key);

      const tickFrame = (now)=>{
        const p = clamp((now - start)/duration, 0, 1);
        const percent = Math.round(p*100);
        pct.textContent = `${percent}%`;
        barFill.style.width = `${percent}%`;
        timerEl.textContent = fmtTime(Math.round(p*20));

        for(const m of moments){
          if(p >= m.t){
            setTick(m.key, true);
            scanTip.textContent = m.tip;
          }
        }

        if(p < 1){
          requestAnimationFrame(tickFrame);
        }
      };
      requestAnimationFrame(tickFrame);

      const minWait = new Promise(res=>setTimeout(res, duration + 80));
      let metrics = null;
      try{
        await minWait;
        metrics = await metricsPromise;
      }catch{
        metrics = await metricsPromise.catch(()=>[]);
      }

      const coverage =
        filesState.length === 1 ? 0.38 :
        filesState.length === 2 ? 0.62 : 0.84;

      const m = metrics.length ? metrics : [{mean:140,contrast:20,highlightRatio:0.10,glossyRatio:0.10,sharpness:6,decodeFailed:true}];
      const sharpAvg = m.reduce((a,x)=>a+x.sharpness,0)/m.length;
      const contrAvg = m.reduce((a,x)=>a+x.contrast,0)/m.length;
      const glossyAvg = m.reduce((a,x)=>a+x.glossyRatio,0)/m.length;
      const hiAvg = m.reduce((a,x)=>a+x.highlightRatio,0)/m.length;

      const clarity = clamp((sharpAvg/18)*0.65 + (contrAvg/55)*0.35, 0, 1);

      const meanVals = m.map(x=>x.mean);
      const meanSpread = Math.max(...meanVals) - Math.min(...meanVals);
      const consistency = clamp(1 - (meanSpread/90), 0, 1);

      let risk = 0;
      if(filesState.length === 1) risk += 0.30;
      if(clarity < 0.40) risk += 0.30;
      if(glossyAvg > 0.09 || hiAvg > 0.12) risk += 0.22;
      if(consistency < 0.45 && filesState.length >= 2) risk += 0.18;
      if(contrAvg > 60 && sharpAvg < 10) risk += 0.14;
      if(m.some(x=>x.decodeFailed)) risk += 0.16;

      if(activeCategoryKey === "leather" && (glossyAvg > 0.07 || hiAvg > 0.10)) risk += 0.10;
      if(activeCategoryKey === "shoes" && coverage < 0.60) risk += 0.10;

      const riskScore = clamp(risk, 0, 1);

      updateKpi(clarity);

      const anyDecodeFail = m.some(x=>x.decodeFailed);
      decodeNote.style.display = anyDecodeFail ? "" : "none";

      finishResult(category, {
        coverage, clarity, consistency, riskScore,
        glossyAvg, hiAvg, contrAvg, sharpAvg,
        rng
      });
    }

    function finishResult(category, ctx){
      const { coverage, clarity, consistency, riskScore, rng } = ctx;
      const { score, level, confidence } = classify({ coverage, clarity, consistency, riskScore }, rng);

      levelBadge.className = `badge ${badgeClass(level)}`;
      levelBadge.textContent = `RESULT: ${level}`;

      levelTitle.textContent = level;

      const riskTxt = riskScore < 0.25 ? "low" : riskScore < 0.55 ? "medium" : "high";
      const glossy = (ctx.glossyAvg > 0.09 || ctx.hiAvg > 0.12);
      const ask = pick(rng, category.askPool);

      if(level === "WOW"){
        levelSubtitle.textContent = "Okayyy this one holds up. Add to cart?";
      } else if(level === "OK"){
        levelSubtitle.textContent = "We’re one no-filter photo away from yes.";
      } else {
        levelSubtitle.textContent = "Not enough proof to spend money. Next.";
      }

      scorePill.textContent = `SCORE: ${score}/100`;
      updateKpi({ clarity, score, level });

      complimentEl.textContent = pick(rng, COMPLIMENTS);

      const adv = buildEditorialAdvice(category, { coverage, clarity, consistency, riskScore, glossy }, level);

      flagsList.innerHTML = `
        <div class="adviceCol">
          ${adv.tips.map(x=>`
            <div class="adviceCard">
              <div class="adviceTitle">${escapeHtml(x.t)}</div>
              <div class="adviceText">${escapeHtml(x.d)}</div>
            </div>
          `).join("")}
        </div>
        <div class="adviceFinal">${escapeHtml(adv.final)}</div>
      `;

      const obs = buildObservations(category, {
        coverage,
        clarity,
        consistency,
        riskScore,
        glossy,
        ask,
        riskTxt
      }, rng);

      obsList.innerHTML = obs.map(t=>`
        <div class="li">
          <div class="ico"></div>
          <div><div style="font-weight:900">${escapeHtml(t)}</div></div>
        </div>
      `).join("");

      const msgs = pickSellerMessages(category, rng);
      sellerMsgs.innerHTML = msgs.map((m,i)=>`
        <div style="padding:10px 0; border-top:1px dashed rgba(2,6,23,.12)">
          <div class="mono" style="font-weight:900; color:rgba(2,6,23,.78)">Message ${i+1}</div>
          <div style="margin-top:6px"><b>EN:</b> ${escapeHtml(m.en)}</div>
          <div style="margin-top:6px"><b>中文:</b> ${escapeHtml(m.zh)}</div>
        </div>
      `).join("");


      if (btnCopySeller) {
        btnCopySeller.onclick = async () => {
          const text = msgs
            .map((m, i) => `Message ${i + 1}\nEN: ${m.en}\n中文: ${m.zh}\n`)
            .join("\n");

          try {
            await navigator.clipboard.writeText(text);
            toast("Seller text copied");
          } catch {
            const ta = document.createElement("textarea");
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try {
              document.execCommand("copy");
              toast("Seller text copied");
            } catch {
              toast("Couldn’t copy");
            } finally {
              ta.remove();
            }
          }
        };
      }

      btnShare2.onclick = async ()=>{
        const text = `Casual Anatomy: Risk Scan • ${category.label}: ${level} • Score ${score}/100 • Risk: ${riskTxt}`;
        await sharePage(text);
      };

      btnBack.onclick = ()=>toReady();

      toResult();
    }

    btnStart.addEventListener("click", runScan);
    btnStart2.addEventListener("click", runScan);
    btnStartMobile.addEventListener("click", runScan);

    function setDefaults(){
      activeCategoryKey = categorySelect.value;
      applyCategoryUI();
      updateKpi();
      setButtons();
      toReady();
      renderThumbs();
    }

    window.addEventListener("beforeunload", ()=>revokePreviews());
    setDefaults();
  </script>
</body>
</html>
